<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Wioo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Estilos base -->
  <style>
    body { margin:0; font-family:'Segoe UI', sans-serif; background:#f8f9fc; }
    .nav-link {
      display:block;
      background:white;
      color:#7344D0;
      padding:10px 12px;
      border-radius:6px;
      margin-bottom:10px;
      font-weight:bold;
      cursor:pointer;
      text-align:left;
      border:none;
    }
    .card-container {
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      margin-top:20px;
    }
    .card {
      background:white;
      border-radius:8px;
      padding:20px;
      text-align:center;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
      min-width:180px;
      flex:1;
    }
    section { display:none; }

    table td, table th {
  padding: 10px 6px;
  border-bottom: 1px solid #eee;
  word-break: break-word;
  text-align: left;
}

table th {
  background-color: #7344D0;
  color: white;
  font-weight: 600;
}

table {
  table-layout: fixed;
  width: 100%;
    }

    /* 📐 Contenedor que permite scroll horizontal en móvil */
.table-wrapper {
  overflow-x: auto;
  max-width: 100%;
  margin-top: 10px;
}

/* 🧱 Estilo de tabla responsive */
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

table td, table th {
  padding: 10px 6px;
  text-align: left;
  border-bottom: 1px solid #eee;
  word-break: break-word;
  }

    .estado-activo {
  color: #00ff99;
  font-weight: bold;
}
.estado-usado {
  color: #cccccc;
  font-style: italic;
}
  </style>
</head>
<body>
  <div style="display:flex;">
    <!-- Menú lateral -->
    <aside style="width:220px; background:#7344D0; color:white; padding:20px; height:100vh;">
      <h2 style="margin-bottom:20px;">🔧 Panel Wioo</h2>
      <button onclick="mostrarSeccion('resumen')" class="nav-link">📊 Resumen Diario</button>
      <button onclick="mostrarSeccion('unidades')" class="nav-link">🚍 Unidades</button>
      <button onclick="mostrarSeccion('choferes')" class="nav-link">🧑‍💼 Choferes</button>
      <button onclick="mostrarSeccion('comprobantes')" class="nav-link">📥 Comprobantes</button>
      <button onclick="mostrarSeccion('tickets')" class="nav-link">🎫 Tickets</button>
      <button onclick="mostrarSeccion('anuncios')" class="nav-link">📺 Anuncios</button>
      <button onclick="mostrarSeccion('estadisticas')" class="nav-link">📈 Estadísticas</button>
      <button onclick="mostrarSeccion('gestion')" class="nav-link">⚙️ Gestión Técnica</button>
      <button onclick="mostrarSeccion('empresas')" class="nav-link">🏢 Empresas</button>
    </aside>

    <!-- Panel central -->
    <main style="flex:1; padding:30px;">
      <!-- 📊 Resumen del día -->
      <section id="resumen">
        <h2 style="color:#7344D0;">📊 Resumen del Día</h2>
        <div class="card-container">
          <div class="card"><h3>Total de tickets</h3><p>—</p></div>
          <div class="card"><h3>Conexiones activas</h3><p>—</p></div>
          <div class="card"><h3>Comprobantes aprobados</h3><p>—</p></div>
        </div>
      </section>

      <section id="unidades">
  <h2 style="color:#7344D0;">🚍 Estado de Unidades</h2>

  <!-- Tabla operativa -->
  <table style="width:100%; border-collapse:collapse; background:white; margin-top:20px;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Unidad</th><th>Chofer</th><th>Estado</th><th>Tickets generados</th><th>Tickets usados</th><th>Conexión</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>BUS-001</td><td>CHF-1023</td><td>🟢 En ruta</td><td>12</td><td>10</td><td>🟢 Online</td>
        <td>
          <button class="nav-link">🔄 Reiniciar</button>
          <button class="nav-link">🔧 Mantenimiento</button>
          <button class="nav-link">🔒 Inhabilitar</button>
        </td>
      </tr>
      <tr>
        <td>BUS-007</td><td>CHF-1050</td><td>🟡 En terminal</td><td>4</td><td>4</td><td>🟢 Online</td>
        <td><button class="nav-link">🔒 Inhabilitar</button></td>
      </tr>
      <tr>
        <td>BUS-011</td><td>CHF-1168</td><td>🔧 En mantenimiento</td><td>—</td><td>—</td><td>🔴 Offline</td>
        <td><button class="nav-link">✅ Activar</button></td>
      </tr>
    </tbody>
  </table>

  <!-- Horarios asignados -->
  <h3 style="color:#7344D0; margin-top:40px;">🕓 Horarios Asignados</h3>
  <table style="width:100%; border-collapse:collapse; background:white; margin-top:10px;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Unidad</th><th>Salida</th><th>Destino</th><th>Hora salida</th><th>Hora llegada</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>BUS-001</td><td>Terminal Norte</td><td>Valencia</td><td>13:30</td><td>15:15</td></tr>
      <tr><td>BUS-007</td><td>Terminal Sur</td><td>Maracay</td><td>12:40</td><td>14:00</td></tr>
    </tbody>
  </table>
      </section>

      <section id="choferes">
  <h2 style="color:#7344D0;">🧑‍✈️ Choferes por Empresa</h2>

  <!-- Empresa: TransMiranda -->
  <h3 style="margin-top:30px;">🚚 TransMiranda</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Chofer</th><th>Unidad Asignada</th><th>Estado</th><th>Licencia</th><th>Último Servicio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>CHF-1023</td><td>BUS-001</td><td>🟢 Activo</td><td>Tipo D</td><td>2025-08-02</td>
        <td>
          <button class="nav-link">📋 Ver perfil</button>
          <button class="nav-link">🔒 Inhabilitar</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empresa: UniónBus -->
  <h3 style="margin-top:30px;">🚛 UniónBus</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Chofer</th><th>Unidad Asignada</th><th>Estado</th><th>Licencia</th><th>Último Servicio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>CHF-1050</td><td>BUS-007</td><td>🟡 Disponible</td><td>Tipo C</td><td>2025-07-30</td>
        <td>
          <button class="nav-link">📋 Ver perfil</button>
          <button class="nav-link">🔧 Asignar ruta</button>
        </td>
      </tr>
    </tbody>
  </table>
      </section>

      <section id="rutas">
  <h2 style="color:#7344D0;">🧭 Rutas Asignadas</h2>

  <!-- Empresa: TransMiranda -->
  <h3 style="margin-top:30px;">🚚 TransMiranda</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Unidad</th><th>Salida</th><th>Destino</th><th>Hora Salida</th><th>Hora Llegada</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>BUS-001</td><td>Terminal Norte</td><td>Valencia</td><td>13:30</td><td>15:15</td>
        <td>
          <button class="nav-link">📝 Editar</button>
          <button class="nav-link">🔄 Reasignar</button>
          <button class="nav-link">❌ Cancelar</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empresa: UniónBus -->
  <h3 style="margin-top:30px;">🚛 UniónBus</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Unidad</th><th>Salida</th><th>Destino</th><th>Hora Salida</th><th>Hora Llegada</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>BUS-007</td><td>Terminal Sur</td><td>Maracay</td><td>12:40</td><td>14:00</td>
        <td>
          <button class="nav-link">📝 Editar</button>
          <button class="nav-link">🔄 Reasignar</button>
          <button class="nav-link">❌ Cancelar</button>
        </td>
      </tr>
    </tbody>
  </table>
      </section>

      <section id="terminales">
  <h2 style="color:#7344D0;">🏢 Terminales por Empresa</h2>

  <!-- Empresa: TransMiranda -->
  <h3 style="margin-top:30px;">🚚 TransMiranda</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Nombre</th><th>Ubicación</th><th>Capacidad</th><th>Estado</th><th>Última Inspección</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Terminal Norte</td><td>Guarenas</td><td>12 buses</td><td>🟢 Operativo</td><td>2025-08-01</td>
        <td>
          <button class="nav-link">🔍 Inspección</button>
          <button class="nav-link">📝 Editar</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empresa: UniónBus -->
  <h3 style="margin-top:30px;">🚛 UniónBus</h3>
  <table style="width:100%; border-collapse:collapse; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Nombre</th><th>Ubicación</th><th>Capacidad</th><th>Estado</th><th>Última Inspección</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Terminal Sur</td><td>Maracay</td><td>8 buses</td><td>🟡 En revisión</td><td>2025-07-28</td>
        <td>
          <button class="nav-link">🔍 Inspección</button>
          <button class="nav-link">🔧 Programar revisión</button>
        </td>
      </tr>
    </tbody>
  </table>
      </section>

      <section id="comprobantes"
<h2 style="color:#7344D0;">📥 Comprobantes Pendientes</h2>
<div class="table-wrapper">
  <table style="background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Cédula</th><th>Teléfono</th><th>Banco</th><th>Referencia</th><th>Unidad</th><th>Monto</th><th>Hora</th><th>IP</th><th>Acción</th>
      </tr>
    </thead>
    <tbody id="tabla-comprobantes-pendientes"></tbody>
  </table>
</div>

<h2 style="color:#7344D0;">✅ Comprobantes Activos</h2>
<div class="table-wrapper">
  <table style="background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Cédula</th><th>Teléfono</th><th>Banco</th><th>Referencia</th><th>Unidad</th><th>Monto</th><th>Hora</th><th>IP</th>
      </tr>
    </thead>
    <tbody id="tabla-comprobantes-activos"></tbody>
  </table>
</div>
      </section>

      <section id="tickets" style="display:none; padding:20px;">
  <h2>🎫 Tickets generados</h2>
  <table id="tabla-tickets">
    <thead>
      <tr>
        <th>Código</th>
        <th>Unidad</th>
        <th>Hora</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
      </section>

      <section id="gestion">
  <h2 style="color:#7344D0;">⚙️ Gestión Técnica y Administrativa</h2>

  <!-- Empresas -->
  <h3 style="margin-top:30px;">🚛 Empresas de Transporte</h3>
  <div>
    <input type="text" id="nuevaEmpresa" placeholder="Nombre de empresa" />
    <button onclick="agregarEmpresa()">➕ Agregar Empresa</button>
  </div>
  <table style="margin-top:10px; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Empresa</th><th>Tipo</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tabla-empresas"></tbody>
  </table>

  <!-- Choferes -->
  <h3 style="margin-top:40px;">🧑‍✈️ Choferes</h3>
  <div>
    <input type="text" id="nuevoChofer" placeholder="ID Chofer" />
    <input type="text" id="unidadChofer" placeholder="Unidad asignada" />
    <button onclick="agregarChofer()">➕ Agregar Chofer</button>
  </div>
  <table style="margin-top:10px; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>ID</th><th>Unidad</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tabla-choferes"></tbody>
  </table>
      </section>

     <section id="empresas">
  <h2 style="color:#7344D0;">🏢 Empresas de Transporte</h2>

  <!-- Crear empresa -->
  <div style="margin-bottom:20px;">
    <input type="text" id="nombreEmpresa" placeholder="Nombre de empresa" />
    <button onclick="crearEmpresa()">➕ Crear Empresa</button>
  </div>

  <!-- Tabla de empresas -->
  <table style="width:100%; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>Empresa</th><th>Choferes</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaEmpresas"></tbody>
  </table>
     </section> 
    </main>
  

  <!-- 🔍 Script de navegación por secciones -->

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient(
  "https://sjrmzkomzlqpsfvjdnle.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqcm16a29temxxcHNmdmpkbmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDU0NTMsImV4cCI6MjA2ODM4MTQ1M30.lX1F-w3ar2LEunf6OTfHoWkDOGFn4KdFTxEuCm34Wmw"
);

// ✅ Navegación entre secciones
function mostrarSeccion(id) {
  const secciones = document.querySelectorAll("section");
  secciones.forEach(sec => sec.style.display = "none");

  const activa = document.getElementById(id);
  if (activa) {
    activa.style.display = "block";
    if (id === "tickets") cargarTickets();
    if (id === "comprobantes") renderComprobantes();
    if (id === "empresas") cargarEmpresas();
    if (id === "gestion") cargarGestion();
  }
}
window.mostrarSeccion = mostrarSeccion;
window.onload = () => mostrarSeccion('resumen');


// ✅ Tickets generados
async function cargarTickets() {
  const tabla = document.getElementById("tabla-tickets").querySelector("tbody");
  if (!tabla) return;

  tabla.innerHTML = "<tr><td colspan='4'>⏳ Cargando tickets...</td></tr>";

  const { data, error } = await supabase
    .from('codigos_activos')
    .select('*')
    .order('creado_en', { ascending: false });

  if (error || !data) {
    tabla.innerHTML = "<tr><td colspan='4'>⛔ Error al cargar datos</td></tr>";
    return;
  }

  if (data.length === 0) {
    tabla.innerHTML = "<tr><td colspan='4'>📭 No hay tickets generados</td></tr>";
    return;
  }

  tabla.innerHTML = "";
  data.forEach(ticket => {
    const hora = ticket.creado_en
      ? new Date(ticket.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : "—";

    const estado = ticket.activo === true || ticket.activo === "true" ? "🟢 Activo" : "⚪ Usado";
    const claseEstado = estado === "🟢 Activo" ? "estado-activo" : "estado-usado";

    const fila = `<tr>
      <td>${ticket.codigo ?? '—'}</td>
      <td>${ticket.unidad ?? '—'}</td>
      <td>${hora}</td>
      <td class="${claseEstado}">${estado}</td>
    </tr>`;
    tabla.innerHTML += fila;
  });
}


// ✅ Comprobantes cargados por pasajeros
async function renderComprobantes() {
  const { data, error } = await supabase
    .from('pago_manual')
    .select('*')
    .order('fecha_hora', { ascending: false });

  if (error || !data) return;

  const tablaPendientes = document.getElementById('tabla-comprobantes-pendientes');
  const tablaActivos = document.getElementById('tabla-comprobantes-activos');

  tablaPendientes.innerHTML = '';
  tablaActivos.innerHTML = '';

  data.forEach(c => {
    const hora = new Date(c.fecha_hora).toLocaleTimeString();
    const filaBase = `
      <td>${c.cedula}</td>
      <td>${c.telefono}</td>
      <td>${c.banco}</td>
      <td>${c.referencia}</td>
      <td>${c.unidad}</td>
      <td>${c.monto}</td>
      <td>${hora}</td>
      <td>${c.ip_pasajero ?? '—'}</td>
    `;

    if (c.estado === 'pendiente') {
      const fila = document.createElement('tr');
      fila.innerHTML = filaBase + `
        <td>
          <button onclick="validarComprobante('${c.id}')" style="background:#4CAF50; color:white;">✅ Validar</button>
          <button onclick="rechazarComprobante('${c.id}')" style="background:#f44336; color:white;">❌ Rechazar</button>
        </td>
      `;
      tablaPendientes.appendChild(fila);
    }

    if (c.estado === 'aprobado') {
      const fila = document.createElement('tr');
      fila.innerHTML = filaBase;
      tablaActivos.appendChild(fila);
    }
  });
}


// ✅ Validar comprobante
window.validarComprobante = async (id) => {
  const { data } = await supabase
    .from('pago_manual')
    .select('ip_pasajero')
    .eq('id', id)
    .single();

  const ipPasajero = data?.ip_pasajero ?? null;
  if (!ipPasajero) return alert("⛔ Sin IP registrada.");

  await supabase
    .from('pago_manual')
    .update({
      estado: 'aprobado',
      fecha_validacion: new Date().toISOString()
    })
    .eq('id', id);

  alert("✅ Comprobante aprobado. El pasajero será redirigido a pantalla 4.1.");
  renderComprobantes();
};

// ✅ Rechazar comprobante
window.rechazarComprobante = async (id) => {
  const { data } = await supabase
    .from('pago_manual')
    .select('ip_pasajero')
    .eq('id', id)
    .single();

  const ipPasajero = data?.ip_pasajero ?? null;

  await supabase.from('pago_manual')
    .update({
      estado: 'rechazado',
      motivo_rechazo: 'No se registró pago',
      fecha_validacion: new Date().toISOString()
    })
    .eq('id', id);

  if (ipPasajero) {
    try {
      const respuesta = await fetch('https://TU_ENDPOINT_MIKROTIK/revertir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ip: ipPasajero,
          redirigirPantalla: '4.2' // 👈 instrucción para Mikrotik o panel
        })
      });

      const json = await respuesta.json();
      if (json.ok) {
        alert(`⛔ IP ${ipPasajero} removida de acceso y redirigida a pantalla 4.2`);
      } else {
        alert(`⚠️ Se rechazó el comprobante pero Mikrotik no respondió correctamente.`);
      }
    } catch (e) {
      alert(`⚠️ Comprobante rechazado pero no se pudo cortar acceso Mikrotik.`);
    }
  } else {
    alert("❌ Comprobante rechazado. Sin IP registrada.");
  }

  renderComprobantes();
    }

    async function cargarGestion() {
  const { data: empresas } = await supabase.from('empresas').select('*');
  const { data: choferes } = await supabase.from('choferes').select('*');

  const tablaEmpresas = document.getElementById('tabla-empresas');
  const tablaChoferes = document.getElementById('tabla-choferes');
  tablaEmpresas.innerHTML = '';
  tablaChoferes.innerHTML = '';

  empresas.forEach(e => {
    const fila = `<tr>
      <td>${e.nombre}</td>
      <td>${e.tipo ?? '—'}</td>
      <td>${e.estado ?? '—'}</td>
      <td>
        <button onclick="eliminarEmpresa('${e.id}')">🗑️ Eliminar</button>
      </td>
    </tr>`;
    tablaEmpresas.innerHTML += fila;
  });

  choferes.forEach(c => {
    const fila = `<tr>
      <td>${c.id}</td>
      <td>${c.unidad}</td>
      <td>${c.estado ?? '—'}</td>
      <td>
        <button onclick="eliminarChofer('${c.id}')">🗑️ Eliminar</button>
      </td>
    </tr>`;
    tablaChoferes.innerHTML += fila;
  });
}

window.agregarEmpresa = async () => {
  const nombre = document.getElementById('nuevaEmpresa').value.trim();
  if (!nombre) return alert("❌ Nombre vacío");
  await supabase.from('empresas').insert({ nombre, tipo: 'urbana', estado: 'activa' });
  cargarGestion();
};

window.eliminarEmpresa = async (id) => {
  await supabase.from('empresas').delete().eq('id', id);
  cargarGestion();
};

window.agregarChofer = async () => {
  const id = document.getElementById('nuevoChofer').value.trim();
  const unidad = document.getElementById('unidadChofer').value.trim();
  if (!id || !unidad) return alert("❌ Datos incompletos");
  await supabase.from('choferes').insert({ id, unidad, estado: 'activo' });
  cargarGestion();
};

window.eliminarChofer = async (id) => {
  await supabase.from('choferes').delete().eq('id', id);
  cargarGestion();
};
    
    async function cargarEmpresas() {
  const { data: empresas } = await supabase.from('empresas').select('*');
  const tabla = document.getElementById('tablaEmpresas');
  tabla.innerHTML = '';

  for (const e of empresas) {
    const { data: choferes } = await supabase
      .from('choferes')
      .select('id, unidad')
      .eq('empresa_id', e.id);

    const lista = choferes.map(c => `🧑 ${c.id} (${c.unidad})`).join('<br>') || '—';

    tabla.innerHTML += `<tr>
      <td>${e.nombre}</td>
      <td>${lista}</td>
      <td>
        <button onclick="eliminarEmpresa('${e.id}')">🗑️ Eliminar</button>
      </td>
    </tr>`;
  }
}

window.crearEmpresa = async () => {
  const nombre = document.getElementById('nombreEmpresa').value.trim();
  if (!nombre) return alert("❌ Nombre vacío");
  await supabase.from('empresas').insert({ nombre });
  cargarEmpresas();
};

window.eliminarEmpresa = async (id) => {
  await supabase.from('empresas').delete().eq('id', id);
  cargarEmpresas();
};
  </script>
</body>
  </html>
