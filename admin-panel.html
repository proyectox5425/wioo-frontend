<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Wioo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Estilos base -->
  <style>
    body { margin:0; font-family:'Segoe UI', sans-serif; background:#f8f9fc; }
    .nav-link {
  display: block;
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 12px;
  background-color: white;
  color: #7344D0;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  font-size: 15px;
  text-align: left;
  cursor: pointer;
  box-sizing: border-box;
  transition: background 0.2s ease;
}

.nav-link:hover {
  background-color: #f0f0ff;
}
    .card-container {
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      margin-top:20px;
    }
    .card {
      background:white;
      border-radius:8px;
      padding:20px;
      text-align:center;
      box-shadow:0 0 5px rgba(0,0,0,0.1);
      min-width:180px;
      flex:1;
    }
    section { display:none; }

    table td, table th {
  padding: 10px 6px;
  border-bottom: 1px solid #eee;
  word-break: break-word;
  text-align: left;
}

table th {
  background-color: #7344D0;
  color: white;
  font-weight: 600;
}

table {
  table-layout: fixed;
  width: 100%;
    }

    /* ğŸ“ Contenedor que permite scroll horizontal en mÃ³vil */
.table-wrapper {
  overflow-x: auto;
  max-width: 100%;
  margin-top: 10px;
}

/* ğŸ§± Estilo de tabla responsive */
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 700px;
}

table td, table th {
  padding: 10px 6px;
  text-align: left;
  border-bottom: 1px solid #eee;
  word-break: break-word;
  }

    .estado-activo {
  color: #00ff99;
  font-weight: bold;
}
.estado-usado {
  color: #cccccc;
  font-style: italic;
}
  </style>
</head>
<body>
  <div style="display:flex;">
    <!-- MenÃº lateral -->
    <aside style="width:220px; background:#7344D0; color:white; padding:20px; height:100vh;">
      <h2 style="margin-bottom:20px;">ğŸ”§ Panel Wioo</h2>
      <button onclick="mostrarSeccion('empresas')" class="nav-link">ğŸ¢ Empresas</button>  
      <button onclick="mostrarSeccion('unidades')" class="nav-link">ğŸš Unidades</button>
      <button onclick="mostrarSeccion('choferes')" class="nav-link">ğŸ§‘â€ğŸ’¼ Choferes</button>
<button onclick="mostrarSeccion('resumen')" class="nav-link">ğŸ“Š Resumen Diario</button>
      <button onclick="mostrarSeccion('comprobantes')" class="nav-link">ğŸ“¥ Comprobantes</button>
      <button onclick="mostrarSeccion('tickets')" class="nav-link">ğŸ« Tickets</button>
      <button onclick="mostrarSeccion('anuncios')" class="nav-link">ğŸ“º Anuncios</button>
      <button onclick="mostrarSeccion('estadisticas')" class="nav-link">ğŸ“ˆ EstadÃ­sticas</button>
      <button onclick="mostrarSeccion('gestion')" class="nav-link">âš™ï¸ GestiÃ³n TÃ©cnica</button>
    </aside>

    <!-- Panel central -->
    <main style="flex:1; padding:30px;">
      <!-- ğŸ“Š Resumen del dÃ­a -->
      <section id="resumen">
  <h2 style="color:#7344D0;">ğŸ“Š Resumen Operativo</h2>

<div style="margin-top:20px; margin-bottom:30px; display:flex; gap:12px; flex-wrap:wrap;">
  <select id="filtroEmpresaResumen">
    <option value="">ğŸ¢ Empresa</option>
  </select>
  <select id="filtroUnidadResumen">
    <option value="">ğŸš Unidad</option>
  </select>
  <select id="filtroChoferResumen">
    <option value="">ğŸ§‘â€âœˆï¸ Chofer</option>
  </select>
  <input type="date" id="filtroFechaResumen" />
  <button onclick="filtrarResumen()">ğŸ” Buscar</button>
<button onclick="exportarResumen()">ğŸ“¤ Exportar Resumen</button>
</div>

  <div class="card-group">
    <h3>ğŸ“… Hoy</h3>
    <div class="card-container">
      <div class="card"><h4>Tickets</h4><p id="ticketsDia">â³</p></div>
      <div class="card"><h4>Comprobantes</h4><p id="comprobantesDia">â³</p></div>
    </div>
  </div>

  <div class="card-group">
    <h3>ğŸ“ˆ Esta semana</h3>
    <div class="card-container">
      <div class="card"><h4>Tickets</h4><p id="ticketsSemana">â³</p></div>
      <div class="card"><h4>Comprobantes</h4><p id="comprobantesSemana">â³</p></div>
    </div>
  </div>

  <div class="card-group">
    <h3>ğŸ“Š Este mes</h3>
    <div class="card-container">
      <div class="card"><h4>Tickets</h4><p id="ticketsMes">â³</p></div>
      <div class="card"><h4>Comprobantes</h4><p id="comprobantesMes">â³</p></div>
    </div>
  </div>
</section>

      <section id="unidades">
  <h2 style="color:#7344D0;">ğŸš GestiÃ³n de Unidades</h2>

  <!-- Formulario para agregar unidad -->
  <div style="margin-bottom:20px;">
    <input type="text" id="idUnidad" placeholder="ID de unidad (PLACA DEL VEHICULO)" />
 <select id="selectorEmpresaUnidad">
  <option value="">â€” Selecciona empresa â€”</option>
</select>   
<button onclick="agregarUnidad()">â• Agregar Unidad</button>
  </div>

  <!-- Tabla de unidades -->
  <table style="width:100%; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>ID</th><th>Estado</th><th>Chofer</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaUnidades"></tbody>
  </table>
</section>

      <section id="choferes">
  <h2 style="color:#7344D0;">ğŸ§‘â€âœˆï¸ GestiÃ³n de Choferes</h2>

<div style="margin-bottom:20px;">
  <label for="filtroEmpresa">Filtrar por empresa:</label>
  <select id="filtroEmpresa" onchange="filtrarChoferesPorEmpresa()">
    <option value="">â€” Todas â€”</option>
  </select>
</div>

  <!-- Formulario para agregar chofer -->
  <div style="margin-bottom:20px;">
    <input type="text" id="idChofer" placeholder="ID autogenerado" disabled />
<input type="text" id="nombreChofer" placeholder="Nombre completo" />
<input type="text" id="cedulaChofer" placeholder="CÃ©dula" />
<input type="text" id="telefonoChofer" placeholder="TelÃ©fono" />
<input type="text" id="usuarioChofer" placeholder="Usuario de acceso" />
<input type="password" id="claveChofer" placeholder="Clave de acceso" />
<select id="selectorEmpresaChofer">
  <option value="">â€” Selecciona empresa â€”</option>
</select>
    <select id="selectorUnidadChofer">
  <option value="">â€” Selecciona unidad â€”</option>
</select>
    <button onclick="agregarChofer()">â• Agregar Chofer</button>
  </div>

  <!-- Tabla de choferes -->
  <table style="width:100%; background:white;">
    <thead>
  <tr style="background:#7344D0; color:white;">
    <th>ID</th>
    <th>Nombre</th>
    <th>CÃ©dula</th>
    <th>TelÃ©fono</th>
    <th>Empresa</th>
    <th>Unidad</th>
    <th>Usuario</th>
    <th>Estado</th>
    <th>Acciones</th>
  </tr>
</thead>
    <tbody id="tablaChoferes"></tbody>
  </table>
</section>

      <section id="comprobantes">
<h2 style="color:#7344D0;">ğŸ“¥ Comprobantes Pendientes</h2>
<div class="table-wrapper">
  <table style="background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>CÃ©dula</th><th>TelÃ©fono</th><th>Banco</th><th>Referencia</th><th>Unidad</th><th>Monto</th><th>Hora</th><th>IP</th><th>AcciÃ³n</th>
      </tr>
    </thead>
    <tbody id="tabla-comprobantes-pendientes"></tbody>
  </table>
</div>

<h2 style="color:#7344D0;">âœ… Comprobantes Activos</h2>
<div class="table-wrapper">
  <table style="background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>CÃ©dula</th><th>TelÃ©fono</th><th>Banco</th><th>Referencia</th><th>Unidad</th><th>Monto</th><th>Hora</th><th>IP</th>
      </tr>
    </thead>
    <tbody id="tabla-comprobantes-activos"></tbody>
  </table>
</div>
      </section>

      <section id="tickets" style="display:none; padding:20px;">
  <h2>ğŸ« Tickets generados</h2>
  <table id="tabla-tickets">
    <thead>
      <tr>
        <th>CÃ³digo</th>
        <th>Unidad</th>
        <th>Hora</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
      </section>

<section id="anuncios" style="display:none; text-align:center; padding:40px;">
  <h2 style="color:#7344D0;">ğŸ“º SecciÃ³n de Anuncios</h2>
  <p style="font-size:18px; margin-top:20px;">ğŸš§ Esta secciÃ³n estÃ¡ en construcciÃ³n.</p>
  <p style="color:#666;">Estamos definiendo su propÃ³sito institucional. Pronto estarÃ¡ disponible.</p>
</section>

     <section id="gestion" style="display:none;">
  <h2 style="color:#7344D0;">âš™ï¸ GestiÃ³n Institucional</h2>

  <!-- ğŸ” Choferes sin unidad asignada -->
  <h3 style="margin-top:30px;">ğŸ§‘â€âœˆï¸ Choferes sin unidad</h3>
  <table style="width:100%; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>ID</th><th>Licencia</th><th>Empresa</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="choferesSinUnidad"></tbody>
  </table>

  <!-- ğŸš Unidades sin chofer asignado -->
  <h3 style="margin-top:40px;">ğŸš Unidades sin chofer</h3>
  <table style="width:100%; background:white;">
    <thead>
      <tr style="background:#7344D0; color:white;">
        <th>ID</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="unidadesSinChofer"></tbody>
  </table>

  <!-- ğŸ¢ Asignar empresa a chofer -->
  <h3 style="margin-top:40px;">ğŸ¢ Asignar empresa a chofer</h3>
  <div style="margin-bottom:10px;">
    <select id="selectorChofer"></select>
    <select id="selectorEmpresa"></select>
    <button onclick="asignarEmpresaAChofer()">Asignar empresa</button>
  </div>
</section>

     <section id="empresas" class="panel-section">
  <h2>Empresas registradas</h2>

  <div class="form-group">
    <input type="text" id="nombreEmpresa" placeholder="Nombre de la empresa" />
    <input type="text" id="prefijoEmpresa" placeholder="Prefijo institucional (ej: EOC)" />
    <button onclick="agregarEmpresa()">Agregar empresa</button>
  </div>
<div id="logAccion" style="margin-top: 10px; font-weight: bold;"></div>

  <table id="tablaEmpresas">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <!-- Empresas se renderizan aquÃ­ -->
    </tbody>
  </table>
</section>

<section id="estadisticas">
  <h2 style="color:#7344D0;">ğŸ“ˆ EstadÃ­sticas Operativas</h2>

  <div class="table-wrapper">
    <table style="background:white;">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tickets</th>
          <th>Comprobantes</th>
          <th>Choferes activos</th>
        </tr>
      </thead>
      <tbody id="tablaEstadisticas"></tbody>
    </table>
  </div>

  <canvas id="graficoTickets" width="600" height="200" style="margin-top:30px;"></canvas>
  <canvas id="graficoComprobantes" width="600" height="200" style="margin-top:30px;"></canvas>
</section>
    </main>
  

  <!-- ğŸ” Script de navegaciÃ³n por secciones -->

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const supabase = createClient(
  "https://sjrmzkomzlqpsfvjdnle.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqcm16a29temxxcHNmdmpkbmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MDU0NTMsImV4cCI6MjA2ODM4MTQ1M30.lX1F-w3ar2LEunf6OTfHoWkDOGFn4KdFTxEuCm34Wmw"
);

// âœ… NavegaciÃ³n entre secciones
function mostrarSeccion(id) {
  const secciones = document.querySelectorAll("section");
  secciones.forEach(sec => sec.style.display = "none");

  const activa = document.getElementById(id);
  if (activa) {
    activa.style.display = "block";

    if (id === "tickets") cargarTickets();
    if (id === "comprobantes") renderComprobantes();
    if (id === "resumen") {
  cargarResumen();
  cargarFiltrosResumen();
}
    if (id === "empresas") cargarEmpresas();
    if (id === "gestion") cargarGestion();
    if (id === "estadisticas") cargarEstadisticas();

    if (id === "unidades") {
      cargarUnidades();
      cargarEmpresasParaUnidades();
    }

    if (id === "choferes") {
  cargarChoferes();
  cargarUnidadesParaChoferes();
  cargarEmpresasEnFiltro();
  filtrarChoferesPorEmpresa();
  cargarEmpresasParaChoferes();

  // ğŸ” Generar ID institucional al seleccionar empresa
  document.getElementById('selectorEmpresaChofer').addEventListener('change', async (e) => {
    const empresaId = e.target.value;
    if (!empresaId) return;

    const { data: empresaData, error: empresaError } = await supabase
      .from('empresas')
      .select('prefijo_id')
      .eq('id', empresaId)
      .single();

    if (empresaError || !empresaData?.prefijo_id) {
      console.error('â›” Error al obtener prefijo de empresa');
      return;
    }

    const prefijo = empresaData.prefijo_id;

    const { data: choferes, error: choferError } = await supabase
      .from('choferes')
      .select('id')
      .eq('empresa_id', empresaId);

    if (choferError) {
      console.error('â›” Error al consultar choferes:', choferError.message);
      return;
    }

    const usados = choferes
      .map(c => c.id)
      .filter(id => id?.startsWith(`${prefijo}-CHF`))
      .map(id => parseInt(id.split('CHF')[1]))
      .filter(n => !isNaN(n));

    const siguiente = Math.max(...usados, 0) + 1;
    const nuevoId = `${prefijo}-CHF${String(siguiente).padStart(3, '0')}`;

    document.getElementById('idChofer').value = nuevoId;
  });
}
  }
}
window.mostrarSeccion = mostrarSeccion;
window.onload = () => mostrarSeccion('resumen');

async function cargarResumen() {
  const hoy = new Date();
  const yyyy = hoy.getFullYear();
  const mm = String(hoy.getMonth() + 1).padStart(2, '0');
  const dd = String(hoy.getDate()).padStart(2, '0');

  const inicioSemana = new Date(hoy);
  inicioSemana.setDate(hoy.getDate() - hoy.getDay()); // domingo
  const inicioMes = new Date(yyyy, hoy.getMonth(), 1);

  const fechas = {
    dia: `${yyyy}-${mm}-${dd}T00:00:00`,
    semana: inicioSemana.toISOString().split('T')[0] + 'T00:00:00',
    mes: inicioMes.toISOString().split('T')[0] + 'T00:00:00'
  };

  // Tickets
  const [ticketsDia, ticketsSemana, ticketsMes] = await Promise.all([
    supabase.from('codigos_activos').select('id').gte('creado_en', fechas.dia),
    supabase.from('codigos_activos').select('id').gte('creado_en', fechas.semana),
    supabase.from('codigos_activos').select('id').gte('creado_en', fechas.mes)
  ]);

  // Comprobantes aprobados
  const [comprobantesDia, comprobantesSemana, comprobantesMes] = await Promise.all([
    supabase.from('pago_manual').select('id').eq('estado', 'aprobado').gte('fecha_validacion', fechas.dia),
    supabase.from('pago_manual').select('id').eq('estado', 'aprobado').gte('fecha_validacion', fechas.semana),
    supabase.from('pago_manual').select('id').eq('estado', 'aprobado').gte('fecha_validacion', fechas.mes)
  ]);

  // Render
  document.getElementById('ticketsDia').textContent = ticketsDia.data?.length ?? 'â€”';
  document.getElementById('ticketsSemana').textContent = ticketsSemana.data?.length ?? 'â€”';
  document.getElementById('ticketsMes').textContent = ticketsMes.data?.length ?? 'â€”';

  document.getElementById('comprobantesDia').textContent = comprobantesDia.data?.length ?? 'â€”';
  document.getElementById('comprobantesSemana').textContent = comprobantesSemana.data?.length ?? 'â€”';
  document.getElementById('comprobantesMes').textContent = comprobantesMes.data?.length ?? 'â€”';
}

async function filtrarResumen() {
  const empresa = document.getElementById('filtroEmpresaResumen').value;
  const unidad = document.getElementById('filtroUnidadResumen').value;
  const chofer = document.getElementById('filtroChoferResumen').value;
  const fecha = document.getElementById('filtroFechaResumen').value;

  const filtros = {};

  if (empresa) filtros.empresa_id = empresa;
  if (unidad) filtros.unidad = unidad;
  if (chofer) filtros.chofer_id = chofer;

  const fechaISO = fecha ? `${fecha}T00:00:00` : null;

  // Tickets filtrados
  let queryTickets = supabase.from('codigos_activos').select('id');
  if (fechaISO) queryTickets = queryTickets.gte('creado_en', fechaISO);
  if (unidad) queryTickets = queryTickets.eq('unidad', unidad);

  // Comprobantes filtrados
  let queryComprobantes = supabase.from('pago_manual').select('id').eq('estado', 'aprobado');
  if (fechaISO) queryComprobantes = queryComprobantes.gte('fecha_validacion', fechaISO);
  if (unidad) queryComprobantes = queryComprobantes.eq('unidad', unidad);

  const [tickets, comprobantes] = await Promise.all([
    queryTickets,
    queryComprobantes
  ]);

  document.getElementById('ticketsDia').textContent = tickets.data?.length ?? 'â€”';
  document.getElementById('ticketsSemana').textContent = 'â€”';
  document.getElementById('ticketsMes').textContent = 'â€”';

  document.getElementById('comprobantesDia').textContent = comprobantes.data?.length ?? 'â€”';
  document.getElementById('comprobantesSemana').textContent = 'â€”';
  document.getElementById('comprobantesMes').textContent = 'â€”';
}

async function exportarResumen() {
  const empresa = document.getElementById('filtroEmpresaResumen').value;
  const unidad = document.getElementById('filtroUnidadResumen').value;
  const chofer = document.getElementById('filtroChoferResumen').value;
  const fecha = document.getElementById('filtroFechaResumen').value;

  const fechaISO = fecha ? `${fecha}T00:00:00` : null;

  let queryTickets = supabase.from('codigos_activos').select('*');
  let queryComprobantes = supabase.from('pago_manual').select('*').eq('estado', 'aprobado');

  if (fechaISO) {
    queryTickets = queryTickets.gte('creado_en', fechaISO);
    queryComprobantes = queryComprobantes.gte('fecha_validacion', fechaISO);
  }
  if (unidad) {
    queryTickets = queryTickets.eq('unidad', unidad);
    queryComprobantes = queryComprobantes.eq('unidad', unidad);
  }

  const [tickets, comprobantes] = await Promise.all([
    queryTickets,
    queryComprobantes
  ]);

  const resumen = `
ğŸ“¤ RESUMEN OPERATIVO
Fecha: ${fecha || 'â€”'}
Empresa: ${empresa || 'â€”'}
Unidad: ${unidad || 'â€”'}
Chofer: ${chofer || 'â€”'}

ğŸ« Tickets generados: ${tickets.data?.length ?? 'â€”'}
ğŸ“¥ Comprobantes aprobados: ${comprobantes.data?.length ?? 'â€”'}

ğŸ•’ Hora de exportaciÃ³n: ${new Date().toLocaleString()}
`;

  alert(resumen);
}

async function cargarFiltrosResumen() {
  const { data: empresas } = await supabase.from('empresas').select('id, nombre');

  const empresaSelect = document.getElementById('filtroEmpresaResumen');
  const unidadSelect = document.getElementById('filtroUnidadResumen');
  const choferSelect = document.getElementById('filtroChoferResumen');

  empresaSelect.innerHTML = '<option value="">ğŸ¢ Empresa</option>';
  unidadSelect.innerHTML = '<option value="">ğŸš Unidad</option>';
  choferSelect.innerHTML = '<option value="">ğŸ§‘â€âœˆï¸ Chofer</option>';

  empresas?.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.textContent = e.nombre;
    empresaSelect.appendChild(opt);
  });

  // ğŸ” Listener reactivo
  empresaSelect.addEventListener('change', async (e) => {
    const empresaId = e.target.value;
    await cargarUnidadesPorEmpresa(empresaId);
    await cargarChoferesPorEmpresa(empresaId);
  });
}

async function cargarEmpresasParaChoferes() {
  const { data } = await supabase.from('empresas').select('id, nombre');
  const selector = document.getElementById('selectorEmpresaChofer');
  selector.innerHTML = '<option value="">â€” Selecciona empresa â€”</option>';

  data.forEach(e => {
    const option = document.createElement('option');
    option.value = e.id;
    option.textContent = e.nombre;
    selector.appendChild(option);
  });

  // ğŸ” Listener reactivo: actualiza unidades segÃºn empresa
  selector.addEventListener('change', async (e) => {
    const empresaId = e.target.value;
    await cargarUnidadesParaEmpresa(empresaId);
  });
}

async function cargarUnidadesParaEmpresa(empresaId) {
  const selector = document.getElementById('selectorUnidadChofer');
  selector.innerHTML = '<option value="">â€” Selecciona unidad â€”</option>';

  if (!empresaId) return;

  const { data } = await supabase
    .from('unidades')
    .select('id')
    .eq('empresa_id', empresaId);

  data?.forEach(u => {
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.id;
    selector.appendChild(option);
  });
}

async function cargarUnidadesPorEmpresa(empresaId) {
  const unidadSelect = document.getElementById('filtroUnidadResumen');
  unidadSelect.innerHTML = '<option value="">ğŸš Unidad</option>';
  if (!empresaId) return;

  const { data } = await supabase
    .from('unidades')
    .select('id')
    .eq('empresa_id', empresaId);

  data?.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.id;
    opt.textContent = u.id;
    unidadSelect.appendChild(opt);
  });
}

async function cargarChoferesPorEmpresa(empresaId) {
  const choferSelect = document.getElementById('filtroChoferResumen');
  choferSelect.innerHTML = '<option value="">ğŸ§‘â€âœˆï¸ Chofer</option>';
  if (!empresaId) return;

  const { data } = await supabase
    .from('choferes')
    .select('id')
    .eq('empresa_id', empresaId);

  data?.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.id;
    choferSelect.appendChild(opt);
  });
}

// âœ… Tickets generados
async function cargarTickets() {
  const tabla = document.getElementById("tabla-tickets").querySelector("tbody");
  if (!tabla) return;

  tabla.innerHTML = "<tr><td colspan='4'>â³ Cargando tickets...</td></tr>";

  const { data, error } = await supabase
    .from('codigos_activos')
    .select('*')
    .order('creado_en', { ascending: false });

  if (error || !data) {
    tabla.innerHTML = "<tr><td colspan='4'>â›” Error al cargar datos</td></tr>";
    return;
  }

  if (data.length === 0) {
    tabla.innerHTML = "<tr><td colspan='4'>ğŸ“­ No hay tickets generados</td></tr>";
    return;
  }

  tabla.innerHTML = "";
  data.forEach(ticket => {
    const hora = ticket.creado_en
      ? new Date(ticket.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : "â€”";

    const estado = ticket.activo === true || ticket.activo === "true" ? "ğŸŸ¢ Activo" : "âšª Usado";
    const claseEstado = estado === "ğŸŸ¢ Activo" ? "estado-activo" : "estado-usado";

    const fila = `<tr>
      <td>${ticket.codigo ?? 'â€”'}</td>
      <td>${ticket.unidad ?? 'â€”'}</td>
      <td>${hora}</td>
      <td class="${claseEstado}">${estado}</td>
    </tr>`;
    tabla.innerHTML += fila;
  });
}


// âœ… Renderizar comprobantes desde Supabase
async function renderComprobantes() {
  const { data, error } = await supabase
    .from('pago_manual')
    .select('*')
    .order('fecha_hora', { ascending: false });

  if (error || !data) {
    console.error('â›” Error al cargar comprobantes:', error?.message);
    alert("Error al cargar comprobantes");
    return;
  }

  const tablaPendientes = document.getElementById('tabla-comprobantes-pendientes');
  const tablaActivos = document.getElementById('tabla-comprobantes-activos');

  tablaPendientes.innerHTML = '';
  tablaActivos.innerHTML = '';

  data.forEach(c => {
    const hora = new Date(c.fecha_hora).toLocaleTimeString();
    const filaBase = `
      <td>${c.cedula}</td>
      <td>${c.telefono}</td>
      <td>${c.banco}</td>
      <td>${c.referencia}</td>
      <td>${c.unidad}</td>
      <td>${c.monto}</td>
      <td>${hora}</td>
      <td>${c.ip_pasajero ?? 'â€”'}</td>
    `;

    if (c.estado === 'pendiente') {
      const fila = document.createElement('tr');
      fila.innerHTML = filaBase + `
        <td>
          <button onclick="validarComprobante('${c.id}')">âœ… Validar</button>
          <button onclick="rechazarComprobante('${c.id}')">âŒ Rechazar</button>
        </td>
      `;
      tablaPendientes.appendChild(fila);
    }

    if (c.estado === 'aprobado') {
      const fila = document.createElement('tr');
      fila.innerHTML = filaBase;
      tablaActivos.appendChild(fila);
    }
  });
}


// âœ… Validar comprobante usando RPC
window.validarComprobante = async (id) => {
  const { error } = await supabase.rpc('validar_comprobante', {
    comprobante_id: id
  });

  if (error) {
    console.error('â›” Error al validar comprobante:', error.message);
    alert("Error al validar comprobante");
    return;
  }

  alert("âœ… Comprobante validado correctamente");
  renderComprobantes();
};

// âœ… Rechazar comprobante
window.rechazarComprobante = async (id) => {
  const { data, error: fetchError } = await supabase
    .from('pago_manual')
    .select('ip_pasajero')
    .eq('id', id)
    .single();

  const ipPasajero = data?.ip_pasajero ?? null;

  const motivo = "No se registrÃ³ pago"; // o usar prompt si querÃ©s hacerlo dinÃ¡mico

  const { error } = await supabase.rpc('rechazar_comprobante', {
    comprobante_id: id,
    motivo
  });

  if (error) {
    console.error('â›” Error al rechazar comprobante:', error.message);
    alert("Error al rechazar comprobante");
    return;
  }

  if (ipPasajero) {
    try {
      const respuesta = await fetch('https://TU_ENDPOINT_MIKROTIK/revertir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ip: ipPasajero,
          redirigirPantalla: '4.2'
        })
      });

      const json = await respuesta.json();
      if (json.ok) {
        alert(`â›” IP ${ipPasajero} removida de acceso y redirigida a pantalla 4.2`);
      } else {
        alert(`âš ï¸ Se rechazÃ³ el comprobante pero Mikrotik no respondiÃ³ correctamente.`);
      }
    } catch (e) {
      alert(`âš ï¸ Comprobante rechazado pero no se pudo cortar acceso Mikrotik.`);
    }
  } else {
    alert("âŒ Comprobante rechazado. Sin IP registrada.");
  }

  renderComprobantes();
};

    async function cargarGestion() {
  const { data: choferes } = await supabase.from('choferes').select('*');
  const { data: unidades } = await supabase.from('unidades').select('*');
  const { data: empresas } = await supabase.from('empresas').select('id, nombre');

  const sinUnidad = choferes.filter(c => !c.unidad);
  const sinChofer = unidades.filter(u => !u.chofer_id);

  const tablaChoferes = document.getElementById('choferesSinUnidad');
  const tablaUnidades = document.getElementById('unidadesSinChofer');
  const selectorChofer = document.getElementById('selectorChofer');
  const selectorEmpresa = document.getElementById('selectorEmpresa');

  tablaChoferes.innerHTML = '';
  tablaUnidades.innerHTML = '';
  selectorChofer.innerHTML = '';
  selectorEmpresa.innerHTML = '';

  sinUnidad.forEach(c => {
    const fila = `<tr>
      <td>${c.id}</td>
      <td>${c.licencia ?? 'â€”'}</td>
      <td>${c.empresa_id ?? 'â€”'}</td>
      <td><button onclick="asignarUnidad('${c.id}')">ğŸ§© Asignar unidad</button></td>
    </tr>`;
    tablaChoferes.innerHTML += fila;

    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.id;
    selectorChofer.appendChild(option);
  });

  sinChofer.forEach(u => {
    const fila = `<tr>
      <td>${u.id}</td>
      <td>${u.estado}</td>
      <td><button onclick="asignarChofer('${u.id}')">ğŸ§‘â€âœˆï¸ Asignar chofer</button></td>
    </tr>`;
    tablaUnidades.innerHTML += fila;
  });

  empresas.forEach(e => {
    const option = document.createElement('option');
    option.value = e.id;
    option.textContent = e.nombre;
    selectorEmpresa.appendChild(option);
  });
}

async function asignarEmpresaAChofer() {
  const choferId = document.getElementById('selectorChofer').value;
  const empresaId = document.getElementById('selectorEmpresa').value;

  const { error } = await supabase.rpc('asignar_empresa_chofer', {
    chofer_id: choferId,
    nueva_empresa_id: empresaId
  });

  if (error) return alert("â›” Error al asignar empresa");
  alert("âœ… Empresa asignada correctamente");
  cargarGestion();
}
    
    // âœ… Cargar empresas desde Supabase
async function cargarEmpresas() {
  const { data, error } = await supabase.from('empresas').select('*');
  if (error) {
    console.error('â›” Error al cargar empresas:', error.message);
    alert('Error al cargar empresas');
    return;
  }

  const tbody = document.querySelector('#tablaEmpresas tbody');
  tbody.innerHTML = '';

  data.forEach(emp => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${emp.id}</td>
      <td>${emp.nombre}</td>
      <td>${emp.estado}</td>
      <td>
        <button onclick="activarEmpresa('${emp.id}')">âœ… Activar</button>
        <button onclick="desactivarEmpresa('${emp.id}')">â›” Desactivar</button>
        <button onclick="eliminarEmpresa('${emp.id}')">ğŸ—‘ï¸ Eliminar</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// âœ… Agregar empresa con prefijo institucional
async function agregarEmpresa() {
  const nombre = document.getElementById('nombreEmpresa').value.trim();
  const prefijo = document.getElementById('prefijoEmpresa').value.trim();

  if (!nombre || !prefijo) {
    return alert("âŒ Debes ingresar nombre y prefijo.");
  }

  const { error } = await supabase.from('empresas').insert([
    { nombre, prefijo_id: prefijo }
  ]);

  if (error) {
    console.error('â›” Error al registrar empresa:', error.message);
    alert("Error al registrar empresa");
    return;
  }

  alert("âœ… Empresa registrada correctamente.");
  document.getElementById('nombreEmpresa').value = "";
  document.getElementById('prefijoEmpresa').value = "";
  document.getElementById('logAccion').textContent = `âœ… Registrada empresa: ${nombre} (${prefijo})`;
  cargarEmpresas();
}
window.agregarEmpresa = agregarEmpresa;

// âœ… Activar empresa usando RPC
async function activarEmpresa(id) {
  const { error } = await supabase.rpc('activar_empresa', { id_empresa: id });

  if (error) {
    console.error('â›” Error al activar empresa:', error.message);
    alert("Error al activar empresa");
    return;
  }

  alert("âœ… Empresa activada");
  cargarEmpresas();
}

// âœ… Desactivar empresa usando RPC
async function desactivarEmpresa(id) {
  const { error } = await supabase.rpc('desactivar_empresa', { id_empresa: id });

  if (error) {
    console.error('â›” Error al desactivar empresa:', error.message);
    alert("Error al desactivar empresa");
    return;
  }

  alert("âœ… Empresa desactivada");
  cargarEmpresas();
}

// âœ… Eliminar empresa usando RPC
async function eliminarEmpresa(id) {
  const confirmacion = confirm("Â¿EstÃ¡s seguro de que deseas eliminar esta empresa?");
  if (!confirmacion) return;

  const { error } = await supabase.rpc('eliminar_empresa', { id_empresa: id });

  if (error) {
    console.error('â›” Error al eliminar empresa:', error.message);
    alert("Error al eliminar empresa");
    return;
  }

  alert("âœ… Empresa eliminada");
  cargarEmpresas();
}

// âœ… Cargar choferes desde Supabase
async function cargarChoferes() {
  const { data, error } = await supabase.from('choferes').select('*');
  if (error) {
    console.error('â›” Error al cargar choferes:', error.message);
    alert('Error al cargar choferes');
    return;
  }

  const tabla = document.getElementById('tablaChoferes');
  tabla.innerHTML = '';

  data.forEach(c => {
    const fila = `<tr>
      <td>${c.id}</td>
      <td>${c.nombre ?? 'â€”'}</td>
      <td>${c.cedula ?? 'â€”'}</td>
      <td>${c.telefono ?? 'â€”'}</td>
      <td>${c.empresa_id ?? 'â€”'}</td>
      <td>${c.unidad ?? 'â€”'}</td>
      <td>${c.usuario ?? 'â€”'}</td>
      <td>${c.estado ?? 'â€”'}</td>
      <td>
        <button onclick="inhabilitarChofer('${c.id}')">ğŸ”’</button>
        <button onclick="activarChofer('${c.id}')">âœ…</button>
        <button onclick="eliminarChofer('${c.id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
    tabla.innerHTML += fila;
  });
}

// âœ… Agregar chofer usando RPC institucional con empresa incluida
window.agregarChofer = async () => {
  const id = document.getElementById('idChofer').value.trim();
  const unidad = document.getElementById('selectorUnidadChofer').value;
  const licencia = document.getElementById('licenciaChofer').value.trim();
  const empresa = document.getElementById('selectorEmpresaChofer').value;
  const nombre = document.getElementById('nombreChofer').value.trim();
  const cedula = document.getElementById('cedulaChofer').value.trim();
  const telefono = document.getElementById('telefonoChofer').value.trim();
  const usuario = document.getElementById('usuarioChofer').value.trim();
  const clave = document.getElementById('claveChofer').value.trim();

  if (!id || !unidad || !licencia || !empresa || !nombre || !cedula || !telefono || !usuario || !clave) {
    return alert("âŒ Datos incompletos");
  }

  const { error } = await supabase.rpc('insertar_chofer', {
    nuevo_id: id,
    nueva_unidad: unidad,
    nueva_empresa_id: empresa,
    nuevo_nombre: nombre,
    nueva_cedula: cedula,
    nuevo_telefono: telefono,
    nuevo_usuario: usuario,
    nueva_clave: clave
  });

  if (error) {
    console.error('â›” Error al registrar chofer:', error.message);
    alert("Error al registrar chofer");
    return;
  }

  alert("âœ… Chofer registrado correctamente");
  cargarChoferes();
};

// âœ… Eliminar chofer usando RPC
window.eliminarChofer = async (id) => {
  const confirmacion = confirm("Â¿EstÃ¡s seguro de que deseas eliminar este chofer?");
  if (!confirmacion) return;

  const { error } = await supabase.rpc('eliminar_chofer', { chofer_id: id });

  if (error) {
    console.error('â›” Error al eliminar chofer:', error.message);
    alert("Error al eliminar chofer");
    return;
  }

  alert("âœ… Chofer eliminado");
  cargarChoferes();
};

// âœ… Inhabilitar chofer usando RPC
window.inhabilitarChofer = async (id) => {
  const { error } = await supabase.rpc('cambiar_estado_chofer', {
    chofer_id: id,
    nuevo_estado: 'inhabilitado'
  });

  if (error) {
    console.error('â›” Error al inhabilitar chofer:', error.message);
    alert("Error al inhabilitar chofer");
    return;
  }

  alert("âœ… Chofer inhabilitado");
  cargarChoferes();
};

// âœ… Activar chofer usando RPC
window.activarChofer = async (id) => {
  const { error } = await supabase.rpc('cambiar_estado_chofer', {
    chofer_id: id,
    nuevo_estado: 'activo'
  });

  if (error) {
    console.error('â›” Error al activar chofer:', error.message);
    alert("Error al activar chofer");
    return;
  }

  alert("âœ… Chofer activado");
  cargarChoferes();
};

// âœ… Cargar unidades desde Supabase
async function cargarUnidades() {
  const { data, error } = await supabase.from('unidades').select('*');
  if (error) {
    console.error('â›” Error al cargar unidades:', error.message);
    alert('Error al cargar unidades');
    return;
  }

  const tabla = document.getElementById('tablaUnidades');
  tabla.innerHTML = '';

  data.forEach(u => {
    const fila = `<tr>
      <td>${u.id}</td>
      <td>${u.estado ?? 'â€”'}</td>
      <td>${u.chofer_id ?? 'â€”'}</td>
      <td>
        <button onclick="activarUnidad('${u.id}')">âœ… Activar</button>
        <button onclick="desactivarUnidad('${u.id}')">â›” Desactivar</button>
        <button onclick="asignarChofer('${u.id}')">ğŸ§‘â€âœˆï¸ Asignar Chofer</button>
        <button onclick="eliminarUnidad('${u.id}')">ğŸ—‘ï¸ Eliminar</button>
      </td>
    </tr>`;
    tabla.innerHTML += fila;
  });
}

// âœ… Agregar unidad usando RPC institucional
window.agregarUnidad = async () => {
  const id = document.getElementById('idUnidad').value.trim();
  const empresaId = document.getElementById('selectorEmpresaUnidad').value;

  if (!id || !empresaId) return alert("âŒ Datos incompletos");

  const { error } = await supabase.rpc('insertar_unidad', {
    unidad_id: id,
    empresa_id: empresaId
  });

  if (error) {
    console.error('â›” Error al registrar unidad:', error.message);
    alert("Error al registrar unidad");
    return;
  }

  alert("âœ… Unidad registrada correctamente");
  document.getElementById('idUnidad').value = "";
  cargarUnidades();
};

// âœ… Eliminar unidad usando RPC
window.eliminarUnidad = async (id) => {
  const confirmacion = confirm("Â¿EstÃ¡s seguro de que deseas eliminar esta unidad?");
  if (!confirmacion) return;

  const { error } = await supabase.rpc('eliminar_unidad', { unidad_id: id });

  if (error) {
    console.error('â›” Error al eliminar unidad:', error.message);
    alert("Error al eliminar unidad");
    return;
  }

  alert("âœ… Unidad eliminada");
  cargarUnidades();
};

// âœ… Activar unidad usando RPC
window.activarUnidad = async (id) => {
  const { error } = await supabase.rpc('activar_unidad', { unidad_id: id });

  if (error) {
    console.error('â›” Error al activar unidad:', error.message);
    alert("Error al activar unidad");
    return;
  }

  alert("âœ… Unidad activada");
  cargarUnidades();
};

// âœ… Desactivar unidad usando RPC
window.desactivarUnidad = async (id) => {
  const { error } = await supabase.rpc('desactivar_unidad', { unidad_id: id });

  if (error) {
    console.error('â›” Error al desactivar unidad:', error.message);
    alert("Error al desactivar unidad");
    return;
  }

  alert("âœ… Unidad desactivada");
  cargarUnidades();
};

// âœ… Asignar chofer a unidad usando RPC
window.asignarChofer = async (unidadId) => {
  const choferId = prompt("ğŸ§‘â€âœˆï¸ ID del chofer a asignar:");
  if (!choferId) return;

  const { error } = await supabase.rpc('asignar_chofer_a_unidad', {
    unidad_id: unidadId,
    chofer_id: choferId
  });

  if (error) {
    console.error('â›” Error al asignar chofer:', error.message);
    alert("Error al asignar chofer");
    return;
  }

  alert("âœ… Chofer asignado correctamente");
  cargarUnidades();
};

async function cargarEmpresasEnFiltro() {
  const { data } = await supabase.from('empresas').select('id, nombre')
  const selector = document.getElementById('filtroEmpresa')
  selector.innerHTML = '<option value="">â€” Todas â€”</option>'

  data.forEach(e => {
    const option = document.createElement('option')
    option.value = e.id
    option.textContent = e.nombre
    selector.appendChild(option)
  })
}

let choferSeleccionado = null

async function abrirAsignacionEmpresa(choferId) {
  choferSeleccionado = choferId
  const { data } = await supabase.from('empresas').select('id, nombre')
  const selector = document.getElementById('selectorEmpresa')
  selector.innerHTML = ''

  data.forEach(e => {
    const option = document.createElement('option')
    option.value = e.id
    option.textContent = e.nombre
    selector.appendChild(option)
  })

  document.getElementById('modalAsignacion').style.display = 'block'
}

async function confirmarAsignacionEmpresa() {
  const empresaId = document.getElementById('selectorEmpresa').value

  const { error } = await supabase.rpc('asignar_empresa_chofer', {
    chofer_id: choferSeleccionado,
    nueva_empresa_id: empresaId
  })

  if (error) {
    alert('Error al asignar empresa')
    return
  }

  document.getElementById('modalAsignacion').style.display = 'none'
  filtrarChoferesPorEmpresa()
}

async function filtrarChoferesPorEmpresa() {
  const empresaId = document.getElementById('filtroEmpresa').value
  let query = supabase.from('choferes').select('*')

  if (empresaId) query = query.eq('empresa_id', empresaId)

  const { data } = await query
  const tabla = document.getElementById('tablaChoferes')
  tabla.innerHTML = ''

  data.forEach(c => {
    const fila = `<tr>
      <td>${c.id}</td>
      <td>${c.unidad}</td>
      <td>${c.estado}</td>
      <td>
        <button onclick="inhabilitarChofer('${c.id}')">ğŸ”’</button>
        <button onclick="activarChofer('${c.id}')">âœ…</button>
        <button onclick="eliminarChofer('${c.id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`
    tabla.innerHTML += fila
  })
}

async function cargarEmpresasParaUnidades() {
  const { data } = await supabase.from('empresas').select('id, nombre');
  const selector = document.getElementById('selectorEmpresaUnidad');
  selector.innerHTML = '<option value="">â€” Selecciona empresa â€”</option>';

  data.forEach(e => {
    const option = document.createElement('option');
    option.value = e.id;
    option.textContent = e.nombre;
    selector.appendChild(option);
  });
}

async function cargarUnidadesParaChoferes() {
  const { data } = await supabase.from('unidades').select('id');
  const selector = document.getElementById('selectorUnidadChofer');
  selector.innerHTML = '<option value="">â€” Selecciona unidad â€”</option>';

  data.forEach(u => {
    const option = document.createElement('option');
    option.value = u.id;
    option.textContent = u.id;
    selector.appendChild(option);
  });
}

async function cargarEstadisticas() {
  const hoy = new Date();
  const fechas = [];

  for (let i = 6; i >= 0; i--) {
    const d = new Date(hoy);
    d.setDate(hoy.getDate() - i);
    fechas.push(d.toISOString().split('T')[0]);
  }

  const etiquetas = fechas.map(f => f); // para mostrar en grÃ¡fico
  const ticketsPorDia = [];
  const comprobantesPorDia = [];

  for (const fecha of fechas) {
    const [tickets, comprobantes] = await Promise.all([
      supabase.from('codigos_activos').select('id').gte('creado_en', `${fecha}T00:00:00`).lt('creado_en', `${fecha}T23:59:59`),
      supabase.from('pago_manual').select('id').eq('estado', 'aprobado').gte('fecha_validacion', `${fecha}T00:00:00`).lt('fecha_validacion', `${fecha}T23:59:59`)
    ]);

    ticketsPorDia.push(tickets.data?.length ?? 0);
    comprobantesPorDia.push(comprobantes.data?.length ?? 0);
  }

  dibujarGrafico('graficoTickets', etiquetas, ticketsPorDia, '#00bfff');
  dibujarGrafico('graficoComprobantes', etiquetas, comprobantesPorDia, '#00ff99');
}

function dibujarGrafico(canvasId, etiquetas, valores, color = '#7344D0') {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const max = Math.max(...valores) || 1;
  const anchoBarra = canvas.width / etiquetas.length;
  const escala = canvas.height / max;

  etiquetas.forEach((etiqueta, i) => {
    const x = i * anchoBarra + 10;
    const altura = valores[i] * escala;
    const y = canvas.height - altura;

    // Barra
    ctx.fillStyle = color;
    ctx.fillRect(x, y, anchoBarra - 20, altura);

    // Etiqueta
    ctx.fillStyle = '#333';
    ctx.font = '12px Segoe UI';
    ctx.fillText(etiqueta.slice(5), x, canvas.height - 5); // muestra solo MM-DD
  });
}
  </script>
</body>
  </html>